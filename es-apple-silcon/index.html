<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 安装 ElasticSearch 7.17.4 与 Logstash / Kibana 到 Apple Silcon (M1 Arm) macOS · NOTED DIM'ENSIONS</title><meta name="description" content="安装 ElasticSearch 7.17.4 与 Logstash / Kibana 到 Apple Silcon (M1 Arm) macOS - Dimpurr"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><script src="//unpkg.com/valine/dist/Valine.min.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://note.dim.moe/atom.xml" title="NOTED DIM'ENSIONS"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item"><b><a href="/" target="_self" class="nav-list-link">NOTED DIM'ENSIONS</a></b></li><li class="nav-list-item"><b><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></b></li><li class="nav-list-item"><b><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></b></li></ul><ul class="nav nav-list"><li class="nav-list-item"><a href="http://blog.dimpurr.com/" target="_blank" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="https://blog.dim.moe/" target="_blank" class="nav-list-link">BLOG.MOE</a></li><li class="nav-list-item"><a href="http://book.dimpurr.com/" target="_blank" class="nav-list-link">BOOK</a></li><li class="nav-list-item"><a href="http://book.dim.moe/" target="_blank" class="nav-list-link">BOOK.MOE</a></li><li class="nav-list-item"><a href="http://note.dimpurr.com/" target="_blank" class="nav-list-link">NOTE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">安装 ElasticSearch 7.17.4 与 Logstash / Kibana 到 Apple Silcon (M1 Arm) macOS</h1><div class="post-info">Oct 11, 2023</div><div class="post-content"><p>由于软件协议问题， brew 官方删除了 es 的源，改为 es 官方自行维护的 tap 。另外，这些 tap 默认都使用包自带的 jdk ，然后会由于 macOS 的权限问题无法运行，因此需要通过 brew 安装 openjdk 后手动指定环境变量。</p>
<h3 id="安装-ElasticSearch"><a href="#安装-ElasticSearch" class="headerlink" title="安装 ElasticSearch"></a>安装 ElasticSearch</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew tap elastic/tap</span><br><span class="line">brew install elastic/tap/elasticsearch-full</span><br></pre></td></tr></table></figure>

<p>这个时候应该会报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error: elastic/tap/elasticsearch-full: Calling plist_options is disabled! Use service.require_root instead.</span><br><span class="line">Please report this issue to the elastic/tap tap (not Homebrew/brew or Homebrew/homebrew-core), or even better, submit a PR to fix it:</span><br><span class="line">  /opt/homebrew/Library/Taps/elastic/homebrew-tap/Formula/elasticsearch-full.rb:68</span><br></pre></td></tr></table></figure>

<p>不用担心，根据 <a target="_blank" rel="noopener" href="https://github.com/elastic/homebrew-tap/issues/146">这个 issue</a> ，只需要找到提示的这个 .rb 文件的对应行，修改并替换：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plist_options :manual =&gt; <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line"><span class="comment"># 修改为↓</span></span><br><span class="line">@plist_manual = <span class="string">&quot;elasticsearch&quot;</span>` </span><br></pre></td></tr></table></figure>

<p>记得重新运行 <code>brew install elastic/tap/elasticsearch-full</code> 。</p>
<p>同时安装 openjdk ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install openjdk</span><br><span class="line">sudo <span class="built_in">ln</span> -sfn /opt/homebrew/opt/openjdk/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk.jdk</span><br></pre></td></tr></table></figure>

<p>这个时候如果直接运行 <code>elasticsearch</code> 是会报错的。</p>
<p>先运行 <code>/usr/libexec/java_home</code> 找到最新的 openjdk 路径，然后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code /opt/homebrew/Cellar/elasticsearch-full/7.17.4/homebrew.mxcl.elasticsearch-full.plist</span><br></pre></td></tr></table></figure>

<p>在最后一个 <code>&lt;/dict&gt;</code> 前插入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>EnvironmentVariables<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span>&gt;</span>ES_JAVA_HOME<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>/opt/homebrew/Cellar/openjdk/21/libexec/openjdk.jdk/Contents/Home<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>记得把 <code>&lt;string&gt;</code> 中的路径改为你的实际 openjdk 路径。</p>
<p>然后执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;\nxpack.ml.enabled: false\n&quot;</span> &gt;&gt; /opt/homebrew/etc/elasticsearch/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<p>再设置一个全局的环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;\nexport ES_JAVA_HOME=<span class="subst">$(/usr/libexec/java_home)</span>\n&quot;</span> &gt;&gt; ~/.zshrc</span><br></pre></td></tr></table></figure>

<p>这时候就可以通过 <code>elasticsearch</code> 或者 <code>brew services start elasticsearch-full</code> 来启动了。</p>
<p>测试一下连接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(base) ➜  ~ curl -s http://localhost:9200</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;Dims-MBP-Max.lan&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;elasticsearch_dimpurr&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;1efKwx_RQFa-BqsDfbUV0Q&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number&quot;</span> : <span class="string">&quot;7.17.4&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_flavor&quot;</span> : <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_type&quot;</span> : <span class="string">&quot;tar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_hash&quot;</span> : <span class="string">&quot;79878662c54c886ae89206c685d9f1051a9d6411&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_date&quot;</span> : <span class="string">&quot;2022-05-18T18:04:20.964345128Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;lucene_version&quot;</span> : <span class="string">&quot;8.11.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_wire_compatibility_version&quot;</span> : <span class="string">&quot;6.8.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_index_compatibility_version&quot;</span> : <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="安装-Logstash"><a href="#安装-Logstash" class="headerlink" title="安装 Logstash"></a>安装 Logstash</h3><p>如法炮制：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install elastic/tap/logstash-full</span><br></pre></td></tr></table></figure>

<p>然后报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Warning: logstash-full: logstash-oss: Calling plist_options is disabled! Use service.require_root instead.</span><br><span class="line">Please report this issue to the elastic/tap tap (not Homebrew/brew or Homebrew/homebrew-core), or even better, submit a PR to fix it:</span><br><span class="line">  /opt/homebrew/Library/Taps/elastic/homebrew-tap/Formula/logstash-oss.rb:43</span><br></pre></td></tr></table></figure>

<p>同样，找到提示的 .rb 文件，修改并替换：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plist_options :manual =&gt; <span class="string">&quot;logstash&quot;</span></span><br><span class="line"><span class="comment"># 修改为↓</span></span><br><span class="line">@plist_manual = <span class="string">&quot;logstash&quot;</span></span><br></pre></td></tr></table></figure>

<p>记得重新运行 <code>brew install elastic/tap/logstash-full</code> 。</p>
<p>然后 <code>code /opt/homebrew/Cellar/logstash-full/7.17.4/homebrew.mxcl.logstash-full.plist</code> 还是增加环境变量，不过这次是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>EnvironmentVariables<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">key</span>&gt;</span>LS_JAVA_HOME<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>/opt/homebrew/Cellar/openjdk/21/libexec/openjdk.jdk/Contents/Home<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后给 zsh 也加上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;\nexport LS_JAVA_HOME=<span class="subst">$(/usr/libexec/java_home)</span>\n&quot;</span> &gt;&gt; ~/.zshrc</span><br></pre></td></tr></table></figure>

<p>这时候你就可以通过 <code>logstash</code> 或者 <code>brew services start logstash-full</code> 来启动了。</p>
<p>你也可以安装插件：<code>logstash-plugin install logstash-input-jdbc</code> 。</p>
<h3 id="安装-Kibana"><a href="#安装-Kibana" class="headerlink" title="安装 Kibana"></a>安装 Kibana</h3><p>一毛一样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install elastic/tap/kibana-full</span><br></pre></td></tr></table></figure>

<p>报错省略，总之编辑对应文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plist_options :manual =&gt; <span class="string">&quot;kibana&quot;</span></span><br><span class="line"><span class="comment"># 修改为↓</span></span><br><span class="line">@plist_manual = <span class="string">&quot;kibana&quot;</span></span><br></pre></td></tr></table></figure>

<p>神奇的是 kibana 好像不需要修改 Java 环境变量，直接 <code>brew services start kibana-full</code> 或者 <code>kibana</code> 就可以了。访问 <a target="_blank" rel="noopener" href="http://localhost:5601/">http://localhost:5601</a> 就能看到漂亮的界面了。</p>
<hr>
<p>参考： <a target="_blank" rel="noopener" href="https://gist.github.com/todgru/0ba097d63318313f12a52594217f8e2b">https://gist.github.com/todgru/0ba097d63318313f12a52594217f8e2b</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/lerna-npm-workspace/" class="next">NEXT</a></div><div id="vcomments"></div><script>new Valine({
    el: '#vcomments',
    //- appId: 'rfGKuOWT2z4nxbjPVxbS4WXu-MdYXbMMI',
    //- appKey: 'oz2sxWkXcOrVCakcq6W4U25y'
    appId: 'PZ0goebhRPBQicUIJUSA6YAv-gzGzoHsz',
    appKey: 'znA3Ts2FYVedjhPph9XtPocZ',
    serverURLs: 'https://pz0goebh.lc-cn-n1-shared.com'
})</script><div class="copyright"><p>© 2020 - 2023 <a href="http://note.dim.moe">Dimpurr</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>